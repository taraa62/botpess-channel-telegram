{"version":3,"sources":["ReplyFromSettings.ts"],"names":["ReplyFromSettings","constructor","bp","parent","replyDefMethods","updateDefSettings","conf","defaultSettings","def","parser","buttonType","Object","assign","reply","event","ctx","chatId","buttons","edit","tBtn","msg","payload","text","settings","t62Settings","telegram","getButtons","parse_mode","type","elements","quick_replies","reply_markup","one_time_keyboard","resize_keyboard","remove_keyboard","dataBtn","sendMessage","sett","getCallBackBtn","title","callback","hide","Markup","callbackButton","getUrlBtn","url","urlButton","res","map","v","push","checkGroupBtn","inlineKeyboard","keyboard","temp","Map","i","length","b","key","callback_data","toLocaleUpperCase","indexOf","gr","split","arr","get","set","Array","from","forEach"],"mappings":"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","sourceRoot":"/home/taras/Документы/svn/botpress_12.1.0/modules/channel-telegram-t62/src/backend","sourcesContent":["import * as sdk from 'botpress/sdk'\nimport Telegraf, { ContextMessageUpdate, Markup } from 'telegraf'\nimport { ExtraEditMessage } from 'telegraf/typings/telegram-types'\nimport { IDefSettingTelegram } from '../config'\nimport { ReplyDefMethods } from './ReplyDefMethods'\nimport { ReplyToClient } from './ReplyToClient'\nimport { ITelButtons, ITelegramSettings } from './typings'\n\nexport class ReplyFromSettings {\n\n  public defaultSettings: IDefSettingTelegram\n\n  constructor(private bp: typeof sdk, private parent: ReplyToClient, private replyDefMethods: ReplyDefMethods) {\n\n  }\n\n  public updateDefSettings(conf: IDefSettingTelegram): void {\n    this.defaultSettings = conf\n\n    const def: IDefSettingTelegram = {\n      parser: 'HTML',\n      buttonType: 'keyboard'\n    }\n    this.defaultSettings = Object.assign(def, this.defaultSettings)\n  }\n\n  public async reply(event: sdk.IO.Event, ctx: Telegraf<ContextMessageUpdate>, chatId: string): Promise<any> {\n\n    let buttons, edit: ExtraEditMessage, tBtn\n    let msg = event.payload.text\n    let settings: ITelegramSettings = event.payload.t62Settings ? event.payload.t62Settings.telegram : null\n    if (settings) {\n      settings = Object.assign(settings, this.defaultSettings)\n      buttons = this.getButtons(settings.buttons)\n      edit = {\n        parse_mode: settings.parser || 'HTML'\n      }\n      tBtn = (!buttons) ? tBtn : (settings.buttons.type !== 'keyboard') ? 'inline_keyboard' : 'keyboard'\n    } else if (this.defaultSettings) {\n      buttons = this.getButtons({\n        type: this.defaultSettings.buttonType,\n        buttons: event.payload.elements || event.payload.quick_replies\n      })\n      edit = {\n        parse_mode: this.defaultSettings.parser\n        /*reply_markup:{\n        }*/\n      }\n\n\n      tBtn = (!buttons) ? tBtn : (this.defaultSettings.buttonType !== 'keyboard') ? 'inline_keyboard' : 'keyboard'\n    }\n\n    (edit as any).reply_markup = {\n      one_time_keyboard: true,\n      resize_keyboard: true,\n      remove_keyboard: !buttons ? true : false\n    }\n    if (buttons && tBtn) {\n      (edit as any).reply_markup = buttons\n    }\n    (ctx as any).dataBtn = buttons\n    await ctx.telegram.sendMessage(chatId, msg, edit)\n\n  }\n\n  private getButtons(sett: ITelButtons) {\n    const getCallBackBtn = (title: string, callback: string, hide: boolean = false) => {\n      return Markup.callbackButton(title, callback, hide)\n    }\n    const getUrlBtn = (title: string, url: string, hide: boolean = false) => {\n      return Markup.urlButton(title, url, hide)\n    }\n    let res: any[] = null\n    if (sett && sett.buttons) {\n      res = []\n      sett.buttons.map(v => {\n        (v.url) ? res.push(getUrlBtn(v.title, v.url || v.payload, !!v.hide)) : res.push(getCallBackBtn(v.title, v.callback || v.payload, !!v.hide))\n      })\n      res = this.checkGroupBtn(res)\n      if (sett.type !== 'keyboard') {\n        return Markup.inlineKeyboard(res)\n      } else {\n        return Markup.keyboard(res)\n      }\n    }\n    return res\n  }\n\n  private checkGroupBtn(buttons: any[]): any[] {\n    const temp = new Map()\n\n    for (let i = 0; i < buttons.length; i++) {\n      const b = buttons[i]\n      const key = (b.payload || b.callback_data || b.title).toLocaleUpperCase()\n      if (key.indexOf('_GR') > -1) {\n        const gr = key.split('_GR')[1]\n        if (gr) {\n          const arr = temp.get(gr) ? temp.get(gr) : []\n          arr.push(b)\n          temp.set(gr, arr)\n        }\n      } else {\n        temp.set(key, [b])\n        // temp[key] = b\n      }\n    }\n\n    const res = []\n    Array.from(temp).forEach(v => res.push(v[1]))\n    return res\n\n  }\n}\n"]}